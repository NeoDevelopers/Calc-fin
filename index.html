<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SamLaser CRM v5.1</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg: #1c1c1e; --card: #2c2c2e; --text: #fff; --hint: #8e8e93; --blue: #0a84ff; --green: #30d158; --orange: #ff9f0a; --red: #ff453a; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, sans-serif; }
    body { background: var(--bg); color: var(--text); padding: 10px; padding-bottom: 90px; }
    
    .nav { display: flex; gap: 5px; margin-bottom: 15px; position: sticky; top: 0; background: var(--bg); z-index: 100; padding: 5px 0; }
    .nav-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; background: #3a3a3c; color: var(--hint); font-size: 12px; font-weight: 600; }
    .nav-btn.active { background: var(--blue); color: #fff; }

    .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 12px; position: relative; }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .status-badge { font-size: 11px; padding: 4px 8px; border-radius: 6px; background: rgba(255,255,255,0.1); }
    
    .info-row { font-size: 13px; color: var(--hint); margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .money-row { display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; margin-top: 8px; font-size: 13px; }
    .debt { color: var(--red); }
    .paid { color: var(--green); }

    .thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #000; }

    /* –ù–û–í–´–ô –ë–õ–û–ö –û–®–ò–ë–ö–ò */
    .error-box { 
      background: rgba(255, 69, 58, 0.15); 
      border: 1px solid var(--red); 
      color: var(--red); 
      padding: 15px; 
      border-radius: 12px; 
      margin: 10px 0; 
      display: none; 
      font-size: 13px;
      line-height: 1.4;
      word-wrap: break-word;
    }
    
    input, textarea, select { width: 100%; background: #3a3a3c; border: none; border-radius: 8px; color: #fff; padding: 12px; margin-bottom: 10px; outline: none; }
    button { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; }
    .btn-main { background: var(--blue); color: #fff; }
    .btn-action { background: #3a3a3c; color: var(--blue); margin-top: 10px; }
    
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; padding: 20px; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: var(--card); width: 100%; max-width: 400px; padding: 20px; border-radius: 15px; max-height: 90vh; overflow-y: auto; }
    
    .tab { display: none; }
    .tab.active { display: block; }
    #loader { text-align: center; padding: 20px; color: var(--hint); }
  </style>
</head>
<body>

  <div class="nav">
    <button class="nav-btn active" onclick="setTab('calc')">üßÆ –ö–∞–ª—å–∫</button>
    <button class="nav-btn" onclick="setTab('queue')">üìã –û—á–µ—Ä–µ–¥—å</button>
    <button class="nav-btn" onclick="setTab('history')">üóÑ –ê—Ä—Ö–∏–≤</button>
    <button class="nav-btn" onclick="setTab('admin')" id="admin-nav" style="display:none;">‚öôÔ∏è</button>
  </div>

  <div id="login-screen" class="modal show" style="z-index: 2000;">
    <div class="modal-content" style="text-align: center;">
      <h2>–ö—Ç–æ –≤—ã?</h2>
      <button class="btn-action" onclick="login('–†–æ–º–∞')">–†–æ–º–∞ (–¶–µ—Ö)</button>
      <button class="btn-action" onclick="login('–ú–∏—Ö–∞–∏–ª')">–ú–∏—Ö–∞–∏–ª (–ú–µ–Ω–µ–¥–∂–µ—Ä)</button>
      <button class="btn-main" onclick="login('–í–ª–∞–¥–µ–ª–µ—Ü')">–í–ª–∞–¥–µ–ª–µ—Ü</button>
    </div>
  </div>

  <div id="tab-calc" class="tab active">
    <div class="card" style="text-align: center;">
      <h1 id="price-display" style="color:var(--blue); margin: 20px 0;">0 ‚ÇΩ</h1>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <input type="number" id="c-w" placeholder="–®–∏—Ä–∏–Ω–∞" oninput="calc()">
        <input type="number" id="c-h" placeholder="–í—ã—Å–æ—Ç–∞" oninput="calc()">
      </div>
      <input type="number" id="c-s" placeholder="–õ–∏—Å—Ç–æ–≤" value="1.5" oninput="calc()">
      <button class="btn-main" onclick="openOrderModal()">üìù –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
  </div>

  <div id="tab-queue" class="tab">
    <div id="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="error-log" class="error-box"></div> <div id="queue-list"></div>
  </div>

  <div id="tab-history" class="tab">
    <div id="history-list" style="opacity: 0.7;"></div>
  </div>

  <div id="tab-admin" class="tab">
    <div class="card">
      <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <div style="display:flex; justify-content:space-between; margin-top:15px;">
        <span>–°–∫—Ä—ã–≤–∞—Ç—å —Ü–µ–Ω—ã –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º</span>
        <input type="checkbox" id="sett-price" style="width:20px;" onchange="saveSettings()">
      </div>
    </div>
  </div>

  <div class="modal" id="modal-new">
    <div class="modal-content">
      <h3>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h3>
      <input type="text" id="n-client" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞">
      <input type="text" id="n-phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
      <input type="number" id="n-paid" placeholder="–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)">
      <label style="font-size:12px; color:var(--hint);">–§–æ—Ç–æ –º–∞–∫–µ—Ç–∞ / —Å–∫—Ä–∏–Ω—à–æ—Ç</label>
      <input type="file" id="n-photo" accept="image/*">
      <label style="font-size:12px; color:var(--hint);">–§–∞–π–ª –º–∞–∫–µ—Ç–∞</label>
      <input type="file" id="n-layout">
      <textarea id="n-desc" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
      <button class="btn-main" id="btn-submit" onclick="submitOrder()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button class="btn-action" onclick="closeModals()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <div class="modal" id="modal-edit">
    <div class="modal-content">
      <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–º</h3>
      <div id="edit-info" style="margin-bottom:15px; font-size:13px; color:var(--hint);"></div>
      <label>–°—Ç–∞—Ç—É—Å</label>
      <select id="e-status" onchange="checkStatusReq()">
        <option>–ù–æ–≤—ã–π</option>
        <option>–í —Ä–∞–±–æ—Ç–µ</option>
        <option>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
      </select>
      <div id="finish-reqs" style="display:none; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
        <label style="color:var(--green);">–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:</label>
        <input type="text" id="e-tk" placeholder="‚Ññ –ù–∞–∫–ª–∞–¥–Ω–æ–π –¢–ö">
        <label>–§–æ—Ç–æ –≥–æ—Ç–æ–≤–æ–≥–æ –∏–∑–¥–µ–ª–∏—è</label>
        <input type="file" id="e-photo" accept="image/*">
      </div>
      <label>–í–Ω–µ—Å—Ç–∏ –æ–ø–ª–∞—Ç—É (–î–æ–±–∞–≤–∏—Ç—å –∫ —Å—É–º–º–µ)</label>
      <input type="number" id="e-paid-add" placeholder="–°—É–º–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 5000)">
      <button class="btn-main" id="btn-update" onclick="updateOrder()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn-action" onclick="closeModals()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxyfKEG2iVZBcc9ZTx0bLud8uQ2kUAADyJEAJrpODfC9wSRCnSAqNgHuP-F1CcQzpZXrw/exec";
    let currentUser = '';
    let orders = [];
    let currentEditId = null;
    let currentEditRow = null;

    function login(user) {
      currentUser = user;
      document.getElementById('login-screen').classList.remove('show');
      if(user === '–í–ª–∞–¥–µ–ª–µ—Ü') document.getElementById('admin-nav').style.display = 'block';
      if(user === '–†–æ–º–∞') setTab('queue');
      loadData();
    }

    async function loadData() {
      const loader = document.getElementById('loader');
      const errDiv = document.getElementById('error-log');
      
      loader.style.display = 'block';
      errDiv.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—à–ª—ã–µ –æ—à–∏–±–∫–∏
      
      try {
        const res = await fetch(WEB_APP_URL);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ (200 OK)
        if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${res.status}`);
        
        const text = await res.text(); // –ß–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–∏—à–µ–ª –ª–∏ JSON

        try {
          const data = JSON.parse(text);
          orders = data.orders;
          renderOrders();
        } catch (jsonErr) {
          // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ JSON, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –ø—Ä–∏—à–ª–æ (—á–∞—Å—Ç–æ —Ç–∞–º HTML –æ—à–∏–±–∫–∏ –æ—Ç Google)
          throw new Error("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ –¥–∞–Ω–Ω—ã–µ. –í–æ–∑–º–æ–∂–Ω–æ, –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –û—Ç–≤–µ—Ç: " + text.substring(0, 100) + "...");
        }

      } catch(e) { 
        loader.style.display = 'none';
        errDiv.style.display = 'block';
        errDiv.innerHTML = `‚ö†Ô∏è <b>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:</b><br>${e.message}`;
      }
    }

    function renderOrders() {
      const q = document.getElementById('queue-list');
      const h = document.getElementById('history-list');
      q.innerHTML = ''; h.innerHTML = '';
      document.getElementById('loader').style.display = 'none';

      orders.forEach(o => {
        const isDone = o.status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω';
        const debt = (o.price - (o.paid || 0));
        const color = debt > 0 ? 'debt' : 'paid';
        const debtText = debt > 0 ? `–î–æ–ª–≥: ${debt}` : '–û–ø–ª–∞—á–µ–Ω–æ';
        
        const photoHtml = o.photo ? `<img src="${o.photo}" class="thumb" onclick="window.open('${o.photo}')">` : '';

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header">
            <div>
               <b>‚Ññ${o.id} ${o.client}</b>
               <div style="font-size:11px; color:var(--blue);">${o.manager || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</div>
            </div>
            ${photoHtml}
          </div>
          <div class="info-row">üìû ${o.phone}</div>
          <div class="info-row">üìÖ ${o.date.split(',')[0]} <span class="status-badge">${o.status}</span></div>
          ${o.tk ? `<div class="info-row">üöö –¢–ö: ${o.tk}</div>` : ''}
          
          <div class="money-row">
             <span>üí∞ ${o.price} ‚ÇΩ</span>
             <span class="${color}">${debtText}</span>
          </div>
          <button class="btn-action" style="padding:8px; margin-top:10px;" onclick="openEdit(${o.id})">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
        `;

        if(isDone) h.appendChild(card); else q.appendChild(card);
      });
    }

    function calc() {
      const w = document.getElementById('c-w').value;
      const h = document.getElementById('c-h').value;
      const s = document.getElementById('c-s').value;
      const p = Math.round((w * h / 10000 * 1133) + (s * 600) + 1500);
      document.getElementById('price-display').innerText = p.toLocaleString() + " ‚ÇΩ";
      return p;
    }

    function openOrderModal() { document.getElementById('modal-new').classList.add('show'); }
    
    async function submitOrder() {
      const btn = document.getElementById('btn-submit');
      btn.innerText = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞..."; btn.disabled = true;
      const p1 = await toBase64(document.getElementById('n-photo').files[0]);
      const p2 = await toBase64(document.getElementById('n-layout').files[0]);
      const data = {
        id: Math.floor(Math.random()*9000)+1000,
        title: document.getElementById('n-client').value,
        contact: document.getElementById('n-phone').value,
        price: calc(),
        paid: document.getElementById('n-paid').value,
        desc: document.getElementById('n-desc').value,
        sheets: document.getElementById('c-s').value,
        manager: currentUser,
        photoFile: p1,
        layoutFile: p2
      };
      await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
      closeModals();
      loadData();
      btn.innerText = "üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å"; btn.disabled = false;
    }

    function openEdit(id) {
      const o = orders.find(x => x.id == id);
      currentEditRow = o.rowIndex;
      currentEditId = id;
      document.getElementById('edit-info').innerText = `–ó–∞–∫–∞–∑ ‚Ññ${id} | ${o.client}`;
      document.getElementById('e-status').value = o.status;
      document.getElementById('modal-edit').classList.add('show');
      checkStatusReq();
    }

    function checkStatusReq() {
      const val = document.getElementById('e-status').value;
      document.getElementById('finish-reqs').style.display = val === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' ? 'block' : 'none';
    }

    async function updateOrder() {
      const st = document.getElementById('e-status').value;
      const tk = document.getElementById('e-tk').value;
      const photo = await toBase64(document.getElementById('e-photo').files[0]);
      const addPaid = parseFloat(document.getElementById('e-paid-add').value) || 0;
      const o = orders.find(x => x.id == currentEditId);
      const newPaid = addPaid > 0 ? (parseFloat(o.paid || 0) + addPaid) : undefined;

      if(st === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' && (!tk || !photo)) return alert("–î–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω—É–∂–Ω–æ —Ñ–æ—Ç–æ –∏ –Ω–æ–º–µ—Ä –¢–ö!");

      const btn = document.getElementById('btn-update');
      btn.innerText = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..."; btn.disabled = true;

      await fetch(WEB_APP_URL, { 
        method: 'POST', mode: 'no-cors', 
        body: JSON.stringify({ action: 'updateOrder', id: currentEditId, rowIndex: currentEditRow, status: st, tk: tk, paid: newPaid, photo: photo }) 
      });
      closeModals();
      setTimeout(loadData, 2000); // –î–∞–µ–º –≤—Ä–µ–º—è Google –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      btn.innerText = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å"; btn.disabled = false;
    }

    function setTab(t) {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
      document.getElementById('tab-'+t).classList.add('active');
      event.target.classList.add('active');
      if(t === 'queue' || t === 'history') loadData();
    }
    
    function closeModals() { document.querySelectorAll('.modal').forEach(x => {if(x.id!=='login-screen') x.classList.remove('show')}); }
    const toBase64 = f => !f ? null : new Promise((r,j)=>{const d=new FileReader();d.readAsDataURL(f);d.onload=()=>r(d.result);});
  </script>
</body>
</html>

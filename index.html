<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CRM SoftMastera v3.0</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #1c1c1e; --card: #2c2c2e; --text: #fff; --hint: #8e8e93; 
      --blue: #0a84ff; --green: #30d158; --red: #ff453a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, sans-serif; }
    body { background: var(--bg); color: var(--text); padding: 15px; padding-bottom: 90px; }
    
    .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .logout-btn { background: rgba(255, 255, 255, 0.1); color: var(--text); padding: 6px 12px; border-radius: 8px; font-size: 12px; border: none; }

    .card { background: var(--card); border-radius: 14px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
    h3 { text-align: center; color: var(--blue); margin-bottom: 15px; }
    
    input, textarea { 
      width: 100%; background: #3a3a3c; border: 1px solid transparent; border-radius: 10px; 
      color: #fff; padding: 12px; margin-bottom: 12px; font-size: 16px; outline: none;
    }
    input[type="file"] { padding: 8px; font-size: 13px; background: #2c2c2e; border: 1px dashed var(--hint); }
    label { color: var(--hint); font-size: 13px; margin-bottom: 6px; display: block; }
    
    button { border: none; border-radius: 10px; cursor: pointer; font-size: 15px; font-weight: 600; padding: 14px; transition: 0.2s; }
    button:active { transform: scale(0.98); }

    #toast {
      position: fixed; bottom: -100px; left: 20px; right: 20px;
      background: var(--green); color: white; padding: 16px;
      border-radius: 12px; text-align: center; z-index: 9999; transition: 0.5s;
    }
    #toast.show { bottom: 30px; }

    .price-big { font-size: 32px; font-weight: 800; text-align: center; margin: 20px 0; transition: 0.3s; }
    .price-big.hidden { filter: blur(8px); opacity: 0.3; pointer-events: none; }

    .login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .role-btn { width: 280px; background: #3a3a3c; color: var(--blue); margin-bottom: 12px; padding: 18px; border-radius: 12px; text-align: left; display: flex; justify-content: space-between; }

    .nav { display: flex; gap: 6px; margin-bottom: 20px; background: #3a3a3c; padding: 4px; border-radius: 12px; }
    .nav-btn { flex: 1; padding: 10px; background: transparent; color: var(--hint); border-radius: 8px; font-size: 13px; }
    .nav-btn.active { background: var(--card); color: var(--blue); }
    .tab { display: none; }
    .tab.active { display: block; }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
    .modal.show { display: flex; }
    .modal-content { background: var(--card); width: 100%; max-width: 450px; padding: 24px; border-radius: 18px; }

    .toggle-box { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #3a3a3c; }
  </style>
</head>
<body>

  <div id="toast">‚úÖ –ó–∞–∫–∞–∑ –∏ —Ñ–∞–π–ª—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!</div>

  <div class="login-screen" id="loginScreen">
    <h1 style="margin-bottom: 30px;">üîê CRM SoftMastera</h1>
    <button class="role-btn" onclick="login('roma', '–†–æ–º–∞ (–¶–µ—Ö)')">–†–æ–º–∞ (–¶–µ—Ö) <span>2222</span></button>
    <button class="role-btn" onclick="login('mikhail', '–ú–∏—Ö–∞–∏–ª (–ú–µ–Ω.)')">–ú–∏—Ö–∞–∏–ª (–ú–µ–Ω–µ–¥–∂–µ—Ä) <span>1234</span></button>
    <button class="role-btn" onclick="login('owner', '–í–ª–∞–¥–µ–ª–µ—Ü')">–í–ª–∞–¥–µ–ª–µ—Ü <span>9999</span></button>
  </div>

  <div id="app" style="display:none;">
    <div class="app-header">
      <span class="user-tag" id="userDisplay">–í—ã: ‚Äî</span>
      <button class="logout-btn" onclick="location.reload()">üö™ –í—ã–π—Ç–∏</button>
    </div>

    <div class="nav">
      <button class="nav-btn active" onclick="setTab('calc')" id="btn-calc">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</button>
      <button class="nav-btn" onclick="setTab('queue')" id="btn-queue">üìã –û—á–µ—Ä–µ–¥—å</button>
      <button class="nav-btn" onclick="setTab('admin')" id="btn-admin" style="display:none;">‚öôÔ∏è –ê–¥–º–∏–Ω</button>
    </div>

    <div class="tab active" id="tab-calc">
      <div class="card">
        <h3>–ù–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç</h3>
        <label>–®–∏—Ä–∏–Ω–∞ (—Å–º)</label><input type="number" id="c-width" value="100">
        <label>–í—ã—Å–æ—Ç–∞ (—Å–º)</label><input type="number" id="c-height" value="50">
        <label>–õ–∏—Å—Ç–æ–≤ –∞–∫—Ä–∏–ª–∞</label><input type="number" id="c-sheets" value="1.5" step="0.1">
        
        <div class="price-big" id="price-wrapper">
          <span id="c-result">0 ‚ÇΩ</span>
        </div>
        
        <button onclick="openOrder()" style="width:100%; background:var(--green); color:white;">üìù –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
      </div>
    </div>

    <div class="tab" id="tab-queue">
      <div class="card" style="text-align:center; padding:30px; color:var(--hint);">–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç.</div>
    </div>

    <div class="tab" id="tab-admin">
      <div class="card">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ CRM</h3>
        <div class="toggle-box">
          <span>–û—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ü–µ–Ω—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º</span>
          <input type="checkbox" id="sett-price" style="width: 40px;" onchange="updateSettings()">
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="orderModal">
    <div class="modal-content">
      <h2 style="color: var(--blue); margin-bottom: 20px;">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h2>
      
      <input type="text" id="ord-title" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –∑–∞–∫–∞–∑">
      <input type="text" id="ord-contact" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω / –ö–æ–Ω—Ç–∞–∫—Ç">
      
      <label>üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è / –°–∫—Ä–∏–Ω—à–æ—Ç</label>
      <input type="file" id="file-photo" accept="image/*">
      
      <label>üìÇ –§–∞–π–ª –º–∞–∫–µ—Ç–∞</label>
      <input type="file" id="file-layout">

      <textarea id="ord-desc" rows="2" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
      
      <button onclick="submitOrder()" id="subBtn" style="width:100%; background:var(--green); color:white;">üöÄ –í –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ</button>
      <button onclick="closeModal()" style="width:100%; background:transparent; color:var(--hint); margin-top:10px;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxyfKEG2iVZBcc9ZTx0bLud8uQ2kUAADyJEAJrpODfC9wSRCnSAqNgHuP-F1CcQzpZXrw/exec";
    let currentPrice = 0;
    let currentUser = '';
    let showPriceSetting = true;

    async function login(role, name) {
      currentUser = role;
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('userDisplay').innerText = "–í—ã: " + name;

      if(role === 'owner') document.getElementById('btn-admin').style.display = 'block';
      if(role === 'roma') {
          setTab('queue');
          document.getElementById('btn-calc').style.display = 'none';
      }

      // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ–Ω—ã
      const resp = await fetch(WEB_APP_URL);
      const settings = await resp.json();
      showPriceSetting = settings.showPrice;
      document.getElementById('sett-price').checked = showPriceSetting;
      
      applyPriceVisibility();
      calculate();
    }

    function applyPriceVisibility() {
        const wrapper = document.getElementById('price-wrapper');
        if(currentUser === 'mikhail' && !showPriceSetting) {
            wrapper.classList.add('hidden');
        } else {
            wrapper.classList.remove('hidden');
        }
    }

    async function updateSettings() {
        const val = document.getElementById('sett-price').checked;
        fetch(WEB_APP_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'updateSettings', showPrice: val })
        });
        showPriceSetting = val;
        applyPriceVisibility();
    }

    function setTab(t) {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
      document.getElementById('tab-'+t).classList.add('active');
      event.target.classList.add('active');
    }

    function calculate() {
      const w = parseFloat(document.getElementById('c-width').value) || 0;
      const h = parseFloat(document.getElementById('c-height').value) || 0;
      const s = parseFloat(document.getElementById('c-sheets').value) || 0;
      currentPrice = Math.round((w * h / 10000 * 1133) + (s * 600) + 1500);
      document.getElementById('c-result').innerText = currentPrice.toLocaleString() + " ‚ÇΩ";
    }

    document.querySelectorAll('input').forEach(i => i.addEventListener('input', calculate));

    function openOrder() { document.getElementById('orderModal').classList.add('show'); }
    function closeModal() { document.getElementById('orderModal').classList.remove('show'); }

    const toBase64 = file => new Promise((resolve, reject) => {
        if (!file) resolve(null);
        else {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        }
    });

    async function submitOrder() {
      const title = document.getElementById('ord-title').value;
      if(!title) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!");
      
      const btn = document.getElementById('subBtn');
      btn.innerText = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤..."; btn.disabled = true;

      const photo = await toBase64(document.getElementById('file-photo').files[0]);
      const layout = await toBase64(document.getElementById('file-layout').files[0]);

      const data = {
        id: Math.floor(Math.random() * 9000) + 1000,
        title: title,
        contact: document.getElementById('ord-contact').value,
        desc: document.getElementById('ord-desc').value,
        price: currentPrice,
        sheets: document.getElementById('c-sheets').value,
        photoFile: photo,
        layoutFile: layout
      };

      fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) })
      .then(() => {
        closeModal();
        document.getElementById('toast').classList.add('show');
        setTimeout(() => location.reload(), 3000);
      });
    }
  </script>
</body>
</html>
